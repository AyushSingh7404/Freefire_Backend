# FreeFire Esports — FastAPI Backend

Production-grade backend for a Free Fire fantasy esports platform.

---

## Tech Stack

| Layer | Technology |
|---|---|
| Framework | FastAPI 0.129 |
| Database | PostgreSQL 16 (via SQLAlchemy 2.0) |
| Migrations | Alembic |
| Auth | OAuth2 + JWT (PyJWT) + OTP via Gmail SMTP |
| Payments | Razorpay |
| File Storage | Cloudinary |
| Real-time | Native FastAPI WebSockets |
| Rate Limiting | slowapi |
| Deployment | Docker + Docker Compose |

---

## Project Structure

```
app/
├── main.py               # App factory — registers all routers and middleware
├── config.py             # Settings via pydantic-settings (.env)
├── database.py           # SQLAlchemy engine, session, Base
├── models/               # One SQLAlchemy model file per domain
├── schemas/              # One Pydantic schema file per domain
├── routers/              # One router file per domain (thin — calls services)
├── services/             # Business logic (wallet, room join, OTP, etc.)
├── core/                 # security.py, dependencies.py, exceptions.py, rate_limiter.py
└── middleware/           # audit_middleware.py (explicit call, not HTTP middleware)
```

---

## Quick Start (Docker — recommended)

### 1. Clone and configure

```bash
cp .env.example .env
# Edit .env with your real credentials (see Configuration section below)
```

### 2. Start containers

```bash
docker compose up --build
```

This starts:
- `freefire_api` — FastAPI on port 8000
- `freefire_postgres` — PostgreSQL 16 on port 5432

### 3. Run migrations

```bash
docker compose exec web alembic upgrade head
```

### 4. Verify

```
http://localhost:8000/health   → {"status": "ok"}
http://localhost:8000/docs     → Swagger UI
```

---

## Quick Start (Local — without Docker)

### Prerequisites
- Python 3.12+
- PostgreSQL running locally
- Create a database: `createdb freefire_db`

### Setup

```bash
cd Backend
python -m venv venv
source venv/bin/activate          # Windows: venv\Scripts\activate
pip install -r requirements.txt

cp .env.example .env
# Edit .env with your credentials

alembic upgrade head
uvicorn app.main:app --reload --port 8000
```

---

## Configuration (.env)

Copy `.env.example` to `.env` and fill in every value.

### Gmail SMTP (for OTP emails)
1. Enable 2-Factor Authentication on your Gmail account
2. Go to: [myaccount.google.com](https://myaccount.google.com) → Security → App Passwords
3. Create an App Password for "Mail"
4. Use that 16-character password as `MAIL_PASSWORD` — **not** your real Gmail password

### Razorpay (for coin purchases)
1. Create an account at [razorpay.com](https://razorpay.com)
2. Go to Dashboard → Settings → API Keys
3. Generate Test Keys (starts with `rzp_test_`) for development
4. Use Live Keys (starts with `rzp_live_`) for production

### Cloudinary (for avatar uploads)
1. Create a free account at [cloudinary.com](https://cloudinary.com)
2. Go to your Dashboard
3. Copy Cloud Name, API Key, and API Secret

### Secret Key (for JWT)
Generate a cryptographically secure key:
```bash
python -c "import secrets; print(secrets.token_hex(32))"
```

---

## Alembic Migrations

```bash
# After modifying any model, create a migration
alembic revision --autogenerate -m "describe_what_changed"

# Apply all pending migrations
alembic upgrade head

# Roll back one migration
alembic downgrade -1

# See migration history
alembic history

# See current migration version
alembic current
```

**Always review autogenerated migrations** before applying them. Alembic sometimes misses Enum type changes — handle those manually if needed.

---

## API Overview

### Auth Flow

**Registration:**
```
POST /auth/register        → creates account, sends OTP email
POST /auth/verify-register → verifies OTP, returns {access_token, refresh_token, user}
```

**Login:**
```
POST /auth/login           → validates credentials, sends OTP email
POST /auth/verify-login    → verifies OTP, returns {access_token, refresh_token, user}
```

**Token Refresh:**
```
POST /auth/refresh         → exchange refresh_token for new token pair
```

**Password Reset:**
```
POST /auth/forgot-password → sends OTP (always 200, never reveals if email exists)
POST /auth/reset-password  → verifies OTP, sets new password
```

### Authentication Header
All protected endpoints require:
```
Authorization: Bearer <access_token>
```

### Razorpay Payment Flow
```
POST /wallet/payment/initiate  → {razorpay_order_id, amount_paise, razorpay_key_id, coins}
[Frontend opens Razorpay modal — user pays]
POST /wallet/payment/verify    → {razorpay_order_id, razorpay_payment_id, razorpay_signature, coins}
```
The backend verifies the HMAC-SHA256 signature before crediting any coins.

### WebSocket (room live updates)
```
ws://host/ws/rooms/{room_id}?token=<access_token>
```
Receives JSON events: `{"type": "ROOM_UPDATE", "currentPlayers": 12, "maxPlayers": 30, "status": "open"}`

Send `"ping"` to keep connection alive through idle-closing proxies.

---

## Admin Setup

The first admin account is created manually:

1. Register a normal account via `POST /auth/register` → `POST /auth/verify-register`
2. Connect to the database:
   ```bash
   docker compose exec db psql -U $DATABASE_USERNAME -d $DATABASE_NAME
   ```
3. Run:
   ```sql
   UPDATE users SET is_admin = TRUE WHERE email = 'your_admin@email.com';
   ```
4. That account now has access to all `/admin/*` endpoints

---

## Security Design Notes

- **OTP hashing:** OTPs are bcrypt-hashed before storage — raw OTPs never hit the DB
- **No user enumeration:** Forgot-password always returns 200 regardless of email existence
- **Timing-safe comparison:** Razorpay signature uses `hmac.compare_digest`
- **Banned users:** `is_banned` is checked on every authenticated request, not just login
- **Room join atomicity:** `SELECT FOR UPDATE` on wallet and room prevents race conditions
- **admin_room_id gating:** In-game room code is only revealed to joined players
- **Admin cannot ban admin:** Prevents privilege escalation via the ban endpoint
- **Double payment prevention:** Razorpay payment ID stored as unique transaction reference

---

## Rate Limits

| Endpoint | Limit |
|---|---|
| `/auth/register` | 5/minute per IP |
| `/auth/login` | 10/minute per IP |
| `/auth/send-otp` | 3/minute per IP |
| `/auth/forgot-password` | 3/minute per IP |
| `/rooms/{id}/join` | 5/minute per IP |
| `/wallet/payment/*` | 10/minute per IP |
| All other endpoints | 200/minute per IP (default) |

---

## Production Checklist

Before deploying to VPS:

- [ ] Set `CORS_ORIGINS` to your frontend domain only (not `*`)
- [ ] Use Razorpay Live Keys (not test keys)
- [ ] Remove dev volume mount from `docker-compose.yml`
- [ ] Remove `--reload` flag from `uvicorn` CMD
- [ ] Set up Nginx as reverse proxy with SSL (Let's Encrypt)
- [ ] Set up PostgreSQL backups
- [ ] Rotate `SECRET_KEY` and invalidate all existing JWTs
- [ ] Set up application monitoring (Sentry, etc.)
- [ ] Restrict DB port 5432 to internal network only
